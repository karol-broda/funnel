name: ðŸš€ CI Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  GO_VERSION: '1.21'
  CACHE_VERSION: v1

jobs:
  quality:
    name: ðŸ” code quality
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ”§ setup go environment
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: false

    - name: ðŸ“¦ cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ env.CACHE_VERSION }}-${{ runner.os }}-go-${{ hashFiles('**/go.sum', '**/go.work.sum') }}
        restore-keys: |
          ${{ env.CACHE_VERSION }}-${{ runner.os }}-go-

    - name: ðŸ“‹ download dependencies
      run: make deps

    - name: ðŸŽ¨ check code formatting
      run: |
        echo "ðŸ” Checking code formatting..."
        make fmt
        if [ -n "$(git status --porcelain)" ]; then
          echo "âŒ Code is not formatted properly"
          echo "ðŸ“‹ Here are the formatting issues:"
          git diff
          exit 1
        fi
        echo "âœ… Code formatting is correct"

    - name: ðŸ”Ž run linter
      run: |
        echo "ðŸ” Running linter checks..."
        make lint
        echo "âœ… Linting completed successfully"

    - name: ðŸ›¡ï¸ security scan
      uses: securego/gosec@master
      with:
        args: '-fmt sarif -out gosec.sarif ./...'
      continue-on-error: true

    - name: ðŸ“Š upload security scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: gosec.sarif
      continue-on-error: true

  test:
    name: ðŸ§ª Test Suite
    runs-on: ubuntu-latest
    needs: [quality]
    steps:
    - name: ðŸ“¥ checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ”§ setup go environment
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: false

    - name: ðŸ“¦ cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ env.CACHE_VERSION }}-${{ runner.os }}-go-${{ hashFiles('**/go.sum', '**/go.work.sum') }}
        restore-keys: |
          ${{ env.CACHE_VERSION }}-${{ runner.os }}-go-

    - name: ðŸ“‹ download dependencies
      run: make deps

    - name: ðŸƒ run tests
      run: |
        echo "ðŸ§ª Running test suite..."
        make test
        echo "âœ… Tests completed successfully"

    - name: ðŸ“Š generate coverage report
      run: |
        echo "ðŸ“Š Generating coverage reports for all modules..."
        coverage_files=""
        
        for dir in $(find . -name "go.mod" -not -path "./go.work*" -exec dirname {} \; | sort); do
          module_name=$(basename "$dir")
          echo "ðŸ” Processing module: $module_name (in $dir)"
          
          (cd "$dir" && go test -v -coverprofile="coverage-${module_name}.out" ./...)
          
          if [ -f "$dir/coverage-${module_name}.out" ]; then
            echo "âœ… Coverage generated for $module_name"
            coverage_files="$coverage_files $dir/coverage-${module_name}.out"
          fi
        done
        
        echo "ðŸ“‹ Coverage files generated: $coverage_files"

    - name: ðŸ“ˆ upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports
        path: "**/coverage-*.out"
        retention-days: 30

  build:
    name: ðŸ—ï¸ Build (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ubuntu-latest
    needs: [quality, test]
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
            name: "ðŸ§ Linux AMD64"
          - goos: linux
            goarch: arm64
            name: "ðŸ§ Linux ARM64"
          - goos: darwin
            goarch: amd64
            name: "ðŸŽ macOS Intel"
          - goos: darwin
            goarch: arm64
            name: "ðŸŽ macOS Apple Silicon"
          - goos: windows
            goarch: amd64
            name: "ðŸªŸ Windows AMD64"
    steps:
    - name: ðŸ“¥ checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ”§ setup go environment
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: false

    - name: ðŸ“¦ cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ env.CACHE_VERSION }}-${{ runner.os }}-go-${{ hashFiles('**/go.sum', '**/go.work.sum') }}
        restore-keys: |
          ${{ env.CACHE_VERSION }}-${{ runner.os }}-go-

    - name: ðŸ“‹ download dependencies
      run: make deps

    - name: ðŸ”¨ build binaries for ${{ matrix.name }}
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
      run: |
        EXT=""
        if [ "$GOOS" = "windows" ]; then
          EXT=".exe"
        fi
        
        BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        GIT_COMMIT=${GITHUB_SHA::7}
        GIT_TAG=${GITHUB_REF#refs/tags/}
        VERSION="0.0.1a"
        
        echo "ðŸ—ï¸ Building funnel client for ${{ matrix.name }}..."
        GOOS=$GOOS GOARCH=$GOARCH go build \
          -ldflags "-X github.com/karol-broda/funnel/version.Version=$VERSION \
                    -X github.com/karol-broda/funnel/version.BuildDate=$BUILD_DATE \
                    -X github.com/karol-broda/funnel/version.GitCommit=$GIT_COMMIT \
                    -X github.com/karol-broda/funnel/version.GitTag=$GIT_TAG \
                    -s -w" \
          -o funnel-$GOOS-$GOARCH$EXT \
          ./cmd/funnel
        
        echo "ðŸ—ï¸ Building funnel server for ${{ matrix.name }}..."
        GOOS=$GOOS GOARCH=$GOARCH go build \
          -ldflags "-X github.com/karol-broda/funnel/version.Version=$VERSION \
                    -X github.com/karol-broda/funnel/version.BuildDate=$BUILD_DATE \
                    -X github.com/karol-broda/funnel/version.GitCommit=$GIT_COMMIT \
                    -X github.com/karol-broda/funnel/version.GitTag=$GIT_TAG \
                    -s -w" \
          -o funnel-server-$GOOS-$GOARCH$EXT \
          ./cmd/server
        
        echo "âœ… Build completed successfully for ${{ matrix.name }}"
        
        if [ -f "funnel-$GOOS-$GOARCH$EXT" ] && [ -f "funnel-server-$GOOS-$GOARCH$EXT" ]; then
          echo "ðŸ“¦ Binary sizes:"
          ls -lh funnel*-$GOOS-$GOARCH$EXT
        else
          echo "âŒ Build verification failed"
          exit 1
        fi
        
        rm -f funnel-$GOOS-$GOARCH$EXT funnel-server-$GOOS-$GOARCH$EXT

  build-summary:
    name: ðŸ“‹ Build Summary
    runs-on: ubuntu-latest
    needs: [build]
    if: always()
    steps:
    - name: ðŸ“Š build results summary
      run: |
        echo "## ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ§ Linux AMD64 | ${{ needs.build.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ§ Linux ARM64 | ${{ needs.build.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŽ macOS Intel | ${{ needs.build.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŽ macOS Apple Silicon | ${{ needs.build.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸªŸ Windows AMD64 | ${{ needs.build.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” Code Quality: ${{ needs.quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ§ª Tests: ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ—ï¸ Builds: ${{ needs.build.result == 'success' && 'âœ… All Successful' || 'âŒ Some Failed' }}" >> $GITHUB_STEP_SUMMARY 